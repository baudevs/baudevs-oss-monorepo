#!/bin/sh

# Guard against recursive execution
if [ -n "$SKIP_POST_COMMIT" ]; then
  echo "ğŸ›‘ Skipping post-commit hook (SKIP_POST_COMMIT is set)"
  exit 0
fi

# Get list of changed files in the last commit
echo "ğŸ“‹ Getting changed files..."
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
echo "Changed files:"
echo "$CHANGED_FILES"

# Check if only version files were changed
VERSION_PATTERN="apps/baudevs-dashboard/public/(local-metadata\.json|metadata-history\.json|versions/.*\.json)$"
NON_VERSION_FILES=$(echo "$CHANGED_FILES" | grep -v -E "$VERSION_PATTERN")

if [ -z "$NON_VERSION_FILES" ]; then
  echo "âœ¨ Only version files were changed, skipping metadata generation"
  exit 0
fi

echo "ğŸ“¦ Non-version files changed:"
echo "$NON_VERSION_FILES"

# Get the current git user info
AUTHOR_NAME=$(git config user.name)
AUTHOR_EMAIL=$(git config user.email)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
COMMIT=$(git rev-parse HEAD)

# Generate metadata with a timeout
echo "ğŸ” Generating repository metadata..."
timeout 30s bun run scripts/generate-repo-metadata.ts \
  --author "$AUTHOR_NAME" \
  --email "$AUTHOR_EMAIL" \
  --branch "$BRANCH" \
  --commit "$COMMIT" \
  --local

if [ $? -eq 124 ]; then
  echo "âŒ Metadata generation timed out after 30 seconds"
  exit 1
fi

# Check if metadata files exist before trying to copy them
if [ ! -f "versions/latest.json" ] || [ ! -f "metadata-history.json" ]; then
  echo "âŒ Metadata files not found, skipping copy"
  exit 1
fi

# Copy to dashboard public directory
echo "ğŸ“‹ Updating dashboard metadata..."
mkdir -p apps/baudevs-dashboard/public/versions
cp versions/latest.json apps/baudevs-dashboard/public/local-metadata.json
cp metadata-history.json apps/baudevs-dashboard/public/metadata-history.json

# Check if metadata files changed
echo "ğŸ” Checking for metadata changes..."
if git diff --quiet apps/baudevs-dashboard/public/local-metadata.json apps/baudevs-dashboard/public/metadata-history.json; then
  echo "âœ¨ No metadata changes detected"
else
  echo "ğŸ“ Committing metadata changes..."
  export SKIP_POST_COMMIT=1
  git add apps/baudevs-dashboard/public/local-metadata.json apps/baudevs-dashboard/public/metadata-history.json
  git commit --amend --no-edit
  unset SKIP_POST_COMMIT
fi

echo "âœ… Post-commit hook completed"
