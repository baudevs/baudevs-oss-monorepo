#!/bin/sh

# ANSI color codes that work across platforms
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Function to print the BauDevs logo
print_logo() {
  printf "${BLUE}${BOLD}"
  printf " .----------------. .----------------. .----------------. .----------------. .----------------. .----------------. .----------------. \n"
  printf "| .--------------. | .--------------. | .--------------. | .--------------. | .--------------. | .--------------. | .--------------. |\n"
  printf "| |   ______     | | |      __      | | | _____  _____ | | |  ________    | | |  _________   | | | ____   ____  | | |    _______   | |\n"
  printf "| |  |_   _ \    | | |     /  \     | | ||_   _||_   _|| | | |_   ___ \`.  | | | |_   ___  |  | | ||_  _| |_  _| | | |   /  ___  |  | |\n"
  printf "| |    | |_) |   | | |    / /\ \    | | |  | |    | |  | | |   | |   \`. \ | | |   | |_  \_|  | | |  \ \   / /   | | |  |  (__ \_|  | |\n"
  printf "| |    |  __'.   | | |   / ____ \   | | |  | '    ' |  | | |   | |    | | | | |   |  _|  _   | | |   \ \ / /    | | |   '.___\`-.   | |\n"
  printf "| |   _| |__) |  | | | _/ /    \ \_ | | |   \ \`--' /   | | |  _| |___.' / | | |  _| |___/ |  | | |    \ ' /     | | |  |\`\____) |  | |\n"
  printf "| |  |_______/   | | ||____|  |____|| | |    \`.__.'    | | | |________.'  | | | |_________|  | | |     \_/      | | |  |_______.'  | |\n"
  printf "| |              | | |              | | |              | | |              | | |              | | |              | | |              | |\n"
  printf "| '--------------' | '--------------' | '--------------' | '--------------' | '--------------' | '--------------' | '--------------' |\n"
  printf " '----------------' '----------------' '----------------' '----------------' '----------------' '----------------' '----------------' \n"
  printf "\n"
  printf "${NC}"
}

# Function to print a header box
print_header() {
  printf "\n${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ¯ Post-Commit Hook â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
}

# Function to print a section header
print_section() {
  printf "\n${CYAN}${BOLD}â–¶ %s${NC}\n" "$1"
  printf "${CYAN}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
}

# Print the logo and main header
print_logo
print_header

# Check if we're in a worktree
GIT_DIR=$(git rev-parse --git-dir)
if [ "$GIT_DIR" != ".git" ]; then
  printf "${YELLOW}${BOLD}ğŸŒ³ Status${NC}: ${RED}Skipping${NC} (Worktree detected)\n\n"
  exit 0
fi

# Skip if SKIP_POST_COMMIT is set
if [ -n "$SKIP_POST_COMMIT" ]; then
  printf "${YELLOW}${BOLD}â­ï¸  Status${NC}: ${RED}Skipping${NC} (SKIP_POST_COMMIT is set)\n\n"
  exit 0
fi

# Initialize nvm and set up environment
print_section "ğŸ”§ Environment"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Use the project's Node.js version
if [ -f ".nvmrc" ]; then
  nvm use > /dev/null 2>&1
  NODE_VERSION=$(node -v)
  printf "ğŸ“¦ Node Version â”‚ ${GREEN}%s${NC} (from .nvmrc)\n" "$NODE_VERSION"
else
  nvm use default > /dev/null 2>&1
  NODE_VERSION=$(node -v)
  printf "ğŸ“¦ Node Version â”‚ ${YELLOW}%s${NC} (default)\n" "$NODE_VERSION"
fi

# Get commit info and display in a table
print_section "ğŸ“Š Commit Details"
COMMIT=$(git rev-parse HEAD)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
AUTHOR=$(git log -1 --pretty=format:'%an')
EMAIL=$(git log -1 --pretty=format:'%ae')

printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
printf "â”‚ ğŸ”– Branch   â”‚ %-48s â”‚\n" "$BRANCH"
printf "â”‚ ğŸ”¨ Commit   â”‚ %-48s â”‚\n" "$COMMIT"
printf "â”‚ ğŸ‘¤ Author   â”‚ %-48s â”‚\n" "$AUTHOR"
printf "â”‚ ğŸ“§ Email    â”‚ %-48s â”‚\n" "$EMAIL"
printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

# Check if this commit only contains version files
print_section "ğŸ” Change Analysis"
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
VERSION_FILES_ONLY=true
for file in $CHANGED_FILES; do
  if [[ ! "$file" =~ versions/.*\.json$ ]] && [[ ! "$file" =~ metadata-history\.json$ ]] && [[ ! "$file" =~ local-metadata\.json$ ]]; then
    VERSION_FILES_ONLY=false
    break
  fi
done

if [ "$VERSION_FILES_ONLY" = true ]; then
  printf "${YELLOW}${BOLD}â„¹ï¸  Status${NC}: Skipping (Only version files changed)\n\n"
  exit 0
fi

# Set environment variable to prevent recursive execution
export SKIP_POST_COMMIT=1

# Generate metadata
print_section "ğŸ“ Metadata Generation"
printf "ğŸš€ Processing â”‚ Commit ${CYAN}${BOLD}%s${NC}\n" "$COMMIT"

bun scripts/generate-repo-metadata.ts --author="$AUTHOR" --email="$EMAIL" --branch="$BRANCH" --commit="$COMMIT"

# Copy metadata files to dashboard public directory
print_section "ğŸ“‹ Dashboard Update"
printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
printf "â”‚ ğŸ“‚ Action   â”‚ Copying metadata files to dashboard            â”‚\n"

# Ensure the versions directory exists
mkdir -p apps/baudevs-dashboard/public/versions

# Copy metadata files
if [ -f "metadata-history.json" ]; then
  cp metadata-history.json apps/baudevs-dashboard/public/metadata-history.json
  printf "â”‚ ğŸ“„ History  â”‚ ${GREEN}Copied${NC} metadata-history.json                  â”‚\n"
else
  printf "â”‚ ğŸ“„ History  â”‚ ${RED}Missing${NC} metadata-history.json                  â”‚\n"
fi

if [ -f "versions/latest.json" ]; then
  cp versions/latest.json apps/baudevs-dashboard/public/local-metadata.json
  printf "â”‚ ğŸ“„ Local    â”‚ ${GREEN}Copied${NC} local-metadata.json                    â”‚\n"
else
  printf "â”‚ ğŸ“„ Local    â”‚ ${RED}Missing${NC} local-metadata.json                    â”‚\n"
fi
printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

# Add metadata files to git if they exist
if [ -f "metadata-history.json" ] || [ -f "versions/latest.json" ]; then
  print_section "ğŸ“¦ Git Update"
  printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
  printf "â”‚ ğŸ“ Status   â”‚ Adding metadata files to staging               â”‚\n"

  # Add root metadata files
  git add metadata-history.json versions/latest.json 2>/dev/null || true
  printf "â”‚ ğŸ“ Root     â”‚ Added version files from root directory        â”‚\n"

  # Add dashboard metadata files
  git add apps/baudevs-dashboard/public/metadata-history.json apps/baudevs-dashboard/public/local-metadata.json 2>/dev/null || true
  printf "â”‚ ğŸ“ Dashboardâ”‚ Added version files to dashboard public        â”‚\n"

  # Create a conventional commit message for metadata update
  COMMIT_MSG="chore(metadata): update repository metadata"
  if [ -n "$CI" ]; then
    COMMIT_MSG="$COMMIT_MSG [skip ci]"
    printf "â”‚ ğŸ¤– CI Flag   â”‚ Adding [skip ci] to commit message            â”‚\n"
  fi
  printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

  # Use a new commit instead of amending to avoid triggering hooks again
  SKIP_POST_COMMIT=1 git commit -m "$COMMIT_MSG"
  printf "\n${GREEN}âœ… Success${NC}: Metadata committed with message: ${BOLD}%s${NC}\n\n" "$COMMIT_MSG"
fi
