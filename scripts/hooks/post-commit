#!/bin/sh

# ANSI color codes that work across platforms
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Function to print the BauDevs logo
print_logo() {
  printf "${BLUE}${BOLD}"
  printf "\n"
  printf "  ____                 ____                  \n"
  printf " |  _ \\               |  _ \\                \n"
  printf " | |_) | __ _ _   _  | |  | | _____   _____ \n"
  printf " |  _ < / _\` | | | | | |  | |/ _ \\ \\ / / __|\n"
  printf " | |_) | (_| | |_| | | |__| |  __/\\ V /\\__ \\\n"
  printf " |____/ \\__,_|\\__,_| |_____/ \\___| \\_/ |___/\n"
  printf "\n"
  printf "${NC}"
}

# Function to print a header box
print_header() {
  printf "\n${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ðŸŽ¯ Post-Commit Hook â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
}

# Function to print a section header
print_section() {
  printf "\n${CYAN}${BOLD}â–¶ %s${NC}\n" "$1"
  printf "${CYAN}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
}

# Print the logo and main header
print_logo
print_header

# Check if we're in a worktree
GIT_DIR=$(git rev-parse --git-dir)
if [ "$GIT_DIR" != ".git" ]; then
  printf "${YELLOW}${BOLD}ðŸŒ³ Status${NC}: ${RED}Skipping${NC} (Worktree detected)\n\n"
  exit 0
fi

# Skip if SKIP_POST_COMMIT is set
if [ -n "$SKIP_POST_COMMIT" ]; then
  printf "${YELLOW}${BOLD}â­ï¸  Status${NC}: ${RED}Skipping${NC} (SKIP_POST_COMMIT is set)\n\n"
  exit 0
fi

# Initialize nvm and set up environment
print_section "ðŸ”§ Environment"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Use the project's Node.js version
if [ -f ".nvmrc" ]; then
  nvm use > /dev/null 2>&1
  NODE_VERSION=$(node -v)
  printf "ðŸ“¦ Node Version â”‚ ${GREEN}%s${NC} (from .nvmrc)\n" "$NODE_VERSION"
else
  nvm use default > /dev/null 2>&1
  NODE_VERSION=$(node -v)
  printf "ðŸ“¦ Node Version â”‚ ${YELLOW}%s${NC} (default)\n" "$NODE_VERSION"
fi

# Get commit info and display in a table
print_section "ðŸ“Š Commit Details"
COMMIT=$(git rev-parse HEAD)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
AUTHOR=$(git log -1 --pretty=format:'%an')
EMAIL=$(git log -1 --pretty=format:'%ae')

printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
printf "â”‚ ðŸ”– Branch   â”‚ %-48s â”‚\n" "$BRANCH"
printf "â”‚ ðŸ”¨ Commit   â”‚ %-48s â”‚\n" "$COMMIT"
printf "â”‚ ðŸ‘¤ Author   â”‚ %-48s â”‚\n" "$AUTHOR"
printf "â”‚ ðŸ“§ Email    â”‚ %-48s â”‚\n" "$EMAIL"
printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

# Check if this commit only contains version files
print_section "ðŸ” Change Analysis"
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
VERSION_FILES_ONLY=true
for file in $CHANGED_FILES; do
  if [[ ! "$file" =~ versions/.*\.json$ ]] && [[ ! "$file" =~ metadata-history\.json$ ]] && [[ ! "$file" =~ local-metadata\.json$ ]]; then
    VERSION_FILES_ONLY=false
    break
  fi
done

if [ "$VERSION_FILES_ONLY" = true ]; then
  printf "${YELLOW}${BOLD}â„¹ï¸  Status${NC}: Skipping (Only version files changed)\n\n"
  exit 0
fi

# Set environment variable to prevent recursive execution
export SKIP_POST_COMMIT=1

# Generate metadata
print_section "ðŸ“ Metadata Generation"
printf "ðŸš€ Processing â”‚ Commit ${CYAN}${BOLD}%s${NC}\n" "$COMMIT"

bun scripts/generate-repo-metadata.ts --author="$AUTHOR" --email="$EMAIL" --branch="$BRANCH" --commit="$COMMIT"

# Copy metadata files to dashboard public directory
print_section "ðŸ“‹ Dashboard Update"
printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
printf "â”‚ ðŸ“‚ Action   â”‚ Copying metadata files to dashboard            â”‚\n"

# Ensure the versions directory exists
mkdir -p apps/baudevs-dashboard/public/versions

# Copy metadata files
if [ -f "metadata-history.json" ]; then
  cp metadata-history.json apps/baudevs-dashboard/public/metadata-history.json
  printf "â”‚ ðŸ“„ History  â”‚ ${GREEN}Copied${NC} metadata-history.json                  â”‚\n"
else
  printf "â”‚ ðŸ“„ History  â”‚ ${RED}Missing${NC} metadata-history.json                  â”‚\n"
fi

if [ -f "local-metadata.json" ]; then
  cp local-metadata.json apps/baudevs-dashboard/public/local-metadata.json
  printf "â”‚ ðŸ“„ Local    â”‚ ${GREEN}Copied${NC} local-metadata.json                    â”‚\n"
else
  printf "â”‚ ðŸ“„ Local    â”‚ ${RED}Missing${NC} local-metadata.json                    â”‚\n"
fi
printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

# Add metadata files to git if they exist
if [ -f "metadata-history.json" ] || [ -f "local-metadata.json" ]; then
  print_section "ðŸ“¦ Git Update"
  printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
  printf "â”‚ ðŸ“Ž Status   â”‚ Adding metadata files to staging               â”‚\n"
  git add metadata-history.json local-metadata.json apps/baudevs-dashboard/public/metadata-history.json apps/baudevs-dashboard/public/local-metadata.json 2>/dev/null || true

  # Create a conventional commit message for metadata update
  COMMIT_MSG="chore(metadata): update repository metadata"
  if [ -n "$CI" ]; then
    COMMIT_MSG="$COMMIT_MSG [skip ci]"
    printf "â”‚ ðŸ¤– CI Flag   â”‚ Adding [skip ci] to commit message            â”‚\n"
  fi
  printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"

  # Use a new commit instead of amending to avoid triggering hooks again
  SKIP_POST_COMMIT=1 git commit -m "$COMMIT_MSG"
  printf "\n${GREEN}âœ… Success${NC}: Metadata committed with message: ${BOLD}%s${NC}\n\n" "$COMMIT_MSG"
fi
