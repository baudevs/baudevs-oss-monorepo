#!/bin/sh

# Guard against recursive execution
if [ -n "$SKIP_POST_COMMIT" ]; then
  exit 0
fi

# Check if this commit only contains version files
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
VERSION_FILES_PATTERN="apps/baudevs-dashboard/public/(local-metadata\.json|metadata-history\.json|versions/.*\.json)$"

# If all changed files are version files, skip
if [ $(echo "$CHANGED_FILES" | grep -v -E "$VERSION_FILES_PATTERN" | wc -l) -eq 0 ]; then
  echo "‚ú® Only version files changed, skipping metadata generation"
  exit 0
fi

# Get the current git user info
AUTHOR_NAME=$(git config user.name)
AUTHOR_EMAIL=$(git config user.email)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
COMMIT=$(git rev-parse HEAD)

# Generate metadata
echo "üîç Generating repository metadata..."
bun run scripts/generate-repo-metadata.ts \
  --author "$AUTHOR_NAME" \
  --email "$AUTHOR_EMAIL" \
  --branch "$BRANCH" \
  --commit "$COMMIT" \
  --local

# Copy to dashboard public directory
echo "üìã Updating dashboard metadata..."
mkdir -p apps/baudevs-dashboard/public/versions
cp versions/latest.json apps/baudevs-dashboard/public/local-metadata.json
cp metadata-history.json apps/baudevs-dashboard/public/metadata-history.json

# Add metadata files to the current commit if they changed
if git diff --quiet apps/baudevs-dashboard/public/local-metadata.json apps/baudevs-dashboard/public/metadata-history.json; then
  echo "‚ú® No metadata changes detected"
else
  echo "üìù Committing metadata changes..."
  export SKIP_POST_COMMIT=1
  git add apps/baudevs-dashboard/public/local-metadata.json apps/baudevs-dashboard/public/metadata-history.json
  git commit --amend --no-edit
  unset SKIP_POST_COMMIT
fi

echo "‚úÖ Post-commit hook completed"
